{% extends "base.html" %}
{% block content %}
<div class="container mt-4">

  <!-- Header -->
  <div class="d-flex justify-content-between flex-wrap mb-3">
    <h3>üìö My Library</h3>
    {% if current_user %}
    <div class="d-flex flex-wrap">
      <a href="{{ url_for('export_csv') }}" class="btn btn-outline-primary me-2 mb-2">üìä Export CSV</a>
      <a href="{{ url_for('export_pdf') }}" class="btn btn-outline-danger me-2 mb-2">üìÑ Export PDF</a>
      <a href="{{ url_for('change_password') }}" class="btn btn-outline-warning me-2 mb-2">üîë Change Password</a>
      <a href="{{ url_for('logout') }}" class="btn btn-outline-secondary mb-2">üö™ Logout</a>
    </div>
    {% endif %}
  </div>

  <!-- Filter & View Toggle -->
  <div class="mb-3 d-flex flex-wrap align-items-center">
    <div class="me-3">
      <a href="{{ url_for('index') }}" class="btn btn-outline-secondary {% if not filter_in_library %}active{% endif %}">All Books</a>
      <a href="{{ url_for('index', in_library=1) }}" class="btn btn-outline-secondary {% if filter_in_library %}active{% endif %}">In Library Only</a>
    </div>
    <div class="ms-auto">
      <button class="btn btn-outline-info me-2" id="listViewBtn">List View</button>
      <button class="btn btn-outline-info" id="gridViewBtn">Grid View</button>
    </div>
  </div>

  <!-- Add Book Form -->
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <h5 class="card-title mb-3">‚ûï Add a Book</h5>
      <form method="POST" enctype="multipart/form-data" id="bookForm">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">ISBN</label>
            <input type="text" name="isbn" id="isbn" class="form-control" placeholder="9780143127741" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Cover Image</label>
            <input type="file" name="barcode_image" class="form-control" accept="image/*" capture="camera">
          </div>
        </div>

        <!-- Live Scanner Preview -->
        <div id="scanner" class="mt-3" style="width:100%; max-width:400px; display:none;"></div>
        <button type="button" class="btn btn-outline-dark mt-2" id="startScanner">üì∑ Start Scanner</button>
        <button type="button" class="btn btn-outline-secondary mt-2" id="stopScanner">‚èπ Stop Scanner</button>

        <button type="submit" class="btn btn-primary mt-3">Add Book</button>
      </form>
    </div>
  </div>

  <!-- Books Table (List View) -->
  <div id="listView">
    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead class="table-primary">
          <tr>
            <th>Title</th>
            <th>Author(s)</th>
            <th>Publisher</th>
            <th>Published</th>
            <th>ISBN</th>
            <th>In Library</th>
          </tr>
        </thead>
        <tbody>
        {% for book in books|sort(attribute='title') %}
          <tr>
            <td>{{ book['title'] }}</td>
            <td>{{ book['authors'] }}</td>
            <td>{{ book['publisher'] }}</td>
            <td>{{ book['publishedDate'] }}</td>
            <td>{{ book['isbn'] }}</td>
            <td>
              <input type="checkbox" class="form-check-input inLibraryToggle" data-book-id="{{ book['id'] }}" {% if book['in_library'] %}checked{% endif %}>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Grid View (Cover View) -->
  <div id="gridView" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3" style="display:none;">
    {% for book in books %}
    <div class="col">
      <div class="card shadow-sm h-100">
        {% if book['cover_url'] %}
          <img src="{{ book['cover_url'] }}" class="card-img-top" alt="{{ book['title'] }}">
        {% else %}
          <div class="card-img-top bg-secondary text-white d-flex align-items-center justify-content-center" style="height:200px;">
            No Cover
          </div>
        {% endif %}
        <div class="card-body">
          <h5 class="card-title">{{ book['title'] }}</h5>
          <p class="card-text"><strong>Author:</strong> {{ book['authors'] }}</p>
          <p class="card-text"><strong>ISBN:</strong> {{ book['isbn'] }}</p>
          <div class="form-check">
            <input type="checkbox" class="form-check-input inLibraryToggle" data-book-id="{{ book['id'] }}" {% if book['in_library'] %}checked{% endif %}>
            <label class="form-check-label">In Library</label>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

</div>

<!-- JS -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  // In Library toggle
  document.querySelectorAll(".inLibraryToggle").forEach(el=>{
    el.addEventListener("change", function(){
      const bookId = this.dataset.bookId;
      fetch(`/toggle_in_library/${bookId}`, {method: "POST", headers: {"X-Requested-With":"XMLHttpRequest"}})
        .then(res=>res.json())
        .then(data=>{
          if(!data.success){
            alert("Failed: "+data.message);
            this.checked = !this.checked;
          }
        })
        .catch(()=>{
          alert("Error updating status.");
          this.checked = !this.checked;
        });
    });
  });

  // View toggle
  const listView = document.getElementById("listView");
  const gridView = document.getElementById("gridView");
  document.getElementById("listViewBtn").addEventListener("click", ()=> {
    listView.style.display = "";
    gridView.style.display = "none";
  });
  document.getElementById("gridViewBtn").addEventListener("click", ()=> {
    listView.style.display = "none";
    gridView.style.display = "";
  });

  // Barcode scanner
  let html5QrcodeScanner;
  const isbnInput = document.getElementById("isbn");
  const scannerDiv = document.getElementById("scanner");
  const startBtn = document.getElementById("startScanner");
  const stopBtn = document.getElementById("stopScanner");

  startBtn.addEventListener("click", () => {
    scannerDiv.style.display = "block";
    html5QrcodeScanner = new Html5Qrcode("scanner");

    Html5Qrcode.getCameras().then(cameras => {
      if(cameras && cameras.length) {
        let cameraId = cameras[0].id;
        for (let cam of cameras) {
          if (cam.label.toLowerCase().includes("back") ||
              cam.label.toLowerCase().includes("rear") ||
              cam.label.toLowerCase().includes("environment")) {
            cameraId = cam.id;
            break;
          }
        }
        html5QrcodeScanner.start(
          cameraId,
          { fps: 10, qrbox: 250 },
          qrCodeMessage => {
            isbnInput.value = qrCodeMessage.trim();
            html5QrcodeScanner.stop().then(() => { scannerDiv.style.display = "none"; });
          },
          errorMessage => { console.log("Scanning...", errorMessage); }
        ).catch(err => console.log(err));
      }
    }).catch(err => console.log(err));
  });

  stopBtn.addEventListener("click", () => {
    if(html5QrcodeScanner){
      html5QrcodeScanner.stop().then(() => { scannerDiv.style.display = "none"; })
      .catch(err => console.log(err));
    }
  });
});
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
{% endblock %}
