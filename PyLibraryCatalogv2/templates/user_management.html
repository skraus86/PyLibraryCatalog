{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <h2>User Management</h2>
    <div class="table-responsive mt-3">
        <table class="table table-bordered align-middle">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Username</th>
                    <th>Approved</th>
                    <th>MFA Setup</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr id="userRow{{ user.id }}">
                    <td>{{ user.id }}</td>
                    <td>{{ user.username }}</td>
                    <td>{{ 'Yes' if user.approved else 'No' }}</td>
                    <td>{% if user.mfa_secret %}Set{% else %}Not Set{% endif %}</td>
                    <td>
                        {% if user.username != 'admin' %}
                        {% if not user.approved %}
                        <button class="btn btn-sm btn-success approve-btn" data-id="{{ user.id }}">Approve</button>
                        {% endif %}
                        <button class="btn btn-sm btn-danger delete-btn" data-id="{{ user.id }}">Delete</button>
                        <button class="btn btn-sm btn-warning reset-btn" data-id="{{ user.id }}">Reset Password</button>
                        {% else %}
                        <span class="text-muted">Admin</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal for Reset Password -->
<div class="modal fade" id="resetModal" tabindex="-1" aria-labelledby="resetModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="resetForm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Reset Password</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="resetUserId">
          <div class="mb-3">
            <label for="newPassword" class="form-label">New Password</label>
            <input type="password" class="form-control" id="newPassword" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-warning">Reset Password</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    // Approve User
    document.querySelectorAll(".approve-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            const userId = btn.dataset.id;
            fetch(`/approve_user/${userId}`, {method:'POST'})
                .then(res=>res.json())
                .then(data=>{
                    if(data.success) location.reload();
                    else alert(data.message || "Failed to approve user");
                });
        });
    });

    // Delete User
    document.querySelectorAll(".delete-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            if(!confirm("Are you sure you want to delete this user?")) return;
            const userId = btn.dataset.id;
            fetch(`/delete_user/${userId}`, {method:'POST'})
                .then(res=>res.json())
                .then(data=>{
                    if(data.success) document.getElementById(`userRow${userId}`).remove();
                    else alert(data.message || "Failed to delete user");
                });
        });
    });

    // Reset Password
    let resetModal = new bootstrap.Modal(document.getElementById('resetModal'));
    document.querySelectorAll(".reset-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            document.getElementById('resetUserId').value = btn.dataset.id;
            document.getElementById('newPassword').value = '';
            resetModal.show();
        });
    });

    document.getElementById("resetForm").addEventListener("submit", (e) => {
        e.preventDefault();
        const userId = document.getElementById('resetUserId').value;
        const newPass = document.getElementById('newPassword').value.trim();
        if(!newPass) return alert("Password cannot be empty");
        fetch(`/reset_password/${userId}`, {
            method:'POST',
            headers: {'Content-Type':'application/x-www-form-urlencoded'},
            body: new URLSearchParams({new_password: newPass})
        })
        .then(res=>res.json())
        .then(data=>{
            if(data.success){
                alert("Password reset successfully");
                resetModal.hide();
            } else {
                alert(data.message || "Failed to reset password");
            }
        });
    });
});
</script>
{% endblock %}
